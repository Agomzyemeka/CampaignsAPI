# ============================================
# Docker Compose - Campaigns API Stack
# ============================================
# Includes: API, Redis (Cache), RabbitMQ (Message Queue)
# Run: docker-compose up --build -d
# ============================================

services:
  # ============================================
  # Campaigns API Service
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: campaigns-api
    restart: unless-stopped
    ports:
      - "5000:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/CampaignsAPI.db
      - ConnectionStrings__Redis=redis:6379
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
      - JwtSettings__SecretKey=YourProductionSecretKeyThatShouldBeAtLeast32CharactersLong!
      - JwtSettings__Issuer=CampaignsAPI
      - JwtSettings__Audience=CampaignsAPIClients
      - JwtSettings__ExpiryMinutes=60
    volumes:
      - campaigns-data:/app/data
    networks:
      - campaigns-network
    depends_on:
      - redis
      - rabbitmq

  # ============================================
  # Redis - Distributed Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: campaigns-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - campaigns-network
    command: redis-server --appendonly yes

  # ============================================
  # RabbitMQ - Message Broker
  # ============================================
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: campaigns-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI (guest/guest)
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - campaigns-network

# ============================================
# Networks
# ============================================
networks:
  campaigns-network:
    driver: bridge

# ============================================
# Volumes for Data Persistence
# ============================================
volumes:
  campaigns-data:
    name: campaigns-api-data
  redis-data:
    name: campaigns-redis-data
  rabbitmq-data:
    name: campaigns-rabbitmq-data
